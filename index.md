# 1 MYSQL报文结构
mysql报文包括消息头和消息体两部分。消息头占4个字节，包含消息体长度和序列号，消息头前3个字节是消息体长度，第4字节是报文序列号。

```
+=====================================+
|        | body length       0 : 3    |
| header +----------------------------+
|        | sequence          3 : 1    |
+=====================================+
| body   |                   4 : y    |
+=====================================+
```
## 1.1 消息头
#### 1.1.1 消息体长度
消息体长度，标记当前消息的实际长度，解决tcp粘包的问题，用3个字节，小字节序存储，最大0xFFFFFF。
#### 1.1.2 序列号
在一次完整的请求/响应交互过程中，用于保证消息顺序的正确，每次客户端发起请求时，序号值都会从0开始计算。

## 1.2 消息体
用于存放请求（响应）的内容，长度由消息头中的消息体长度决定。

# 2 登录认证报文
## 2.1 登录认证初始化报文（Server2Client）
成功建立三次握手后，mysql服务端向客户端发送登录认证初始化报文，报文主要包含客户端对密码签名会用到的key。

#### 2.1.1 认证报文消息体
mysql请求响应报文的消息头都是固定（1.1），这里就跳过不说，直接看登录认证初始化报文的消息体结构。
```
+=============================================================+
|  协议版本号                                          0 : 1   |  
+-------------------------------------------------------------+
|  服务版本信息 （包含字符串结尾字符0x00）               1 : x   |   
+-------------------------------------------------------------+
|  客户端连接id                                      x+1 : 4   |
+-------------------------------------------------------------+
|  密码签名用到的随机串key                          x+1+4 : 8   |  
+-------------------------------------------------------------+
|  0x00                                         x+1+4+8 : 1   |
+-------------------------------------------------------------+
|  服务器标识（2字节，小字节序）                 x+1+4+8+1 : 2   |    
+-------------------------------------------------------------+
|  服务端字节编码                             x+1+4+8+1+2 : 1   |  
+-------------------------------------------------------------+
|  服务端状态                              x+1+4+8+1+2+1 : 2   |  
+-------------------------------------------------------------+
|  服务器标识（2字节，大字节序）           x+1+4+8+1+2+1+2 : 2   |
+-------------------------------------------------------------+
|  密码签名用到的随机数key长度（未使用） x+1+4+8+1+2+1+2+2 : 1   |
+-------------------------------------------------------------+
|  填充值0x00                       x+1+4+8+1+2+1+2+2+1 : 10   |  
+-------------------------------------------------------------+
|  密码签名用到的随机串key2       x+1+4+8+1+2+1+2+2+1+10 : 12   | 
+-------------------------------------------------------------+
|  0x00                      x+1+4+8+1+2+1+2+2+1+10+12 : 1    |
+=============================================================+
```
登录认证初始化报文最重要的数据是，向客户端放返回密码签名用到的随机串。

## 2.2 客户端请求登录认证报文（Client2Server）
客户端接收到服务端登录认证初始化报文，解析获取到签名随机串(scramble)，使用随机串对密码进行签名后，连同用户名、字符编码等连接信息一并发送给服务端。

同样，客户端请求服务端的报文也需要一个消息头，消息头格式看（1.1），下面直接看消息体。
#### 2.2.1 请求登录认证报文
```
// 密码签名方式
token = SHA1(scramble + SHA1(SHA1(password))) XOR SHA1(password)

+=============================================================+
|  客户端标识（小字节序）                               0 : 4   |  
+-------------------------------------------------------------+
|  客户端最大消息长度                                   4 : 4   |   
+-------------------------------------------------------------+
|  客户端字节编码                                      8 : 1   |
+-------------------------------------------------------------+
|  填充值0x00                                         9 : 23  |  
+-------------------------------------------------------------+
|  用户名+0x00                                       32 : x   |
+-------------------------------------------------------------+
|  密码签名的token长度y                             32+x : 1   |    
+-------------------------------------------------------------+
|  密码签名的token                                32+x+1 : y   |  
+-------------------------------------------------------------+
|  连接的数据库名（可选）+0x00，总长度z           32+x+1+y : z   |  
+-------------------------------------------------------------+
|  "mysql_native_password"+0x00              32+x+1+y+z : 22  |  
+=============================================================+
```
验证成功，服务端会响应一个ok报文回来；失败，响应error报文。

## 3 总结
以上报文结构，是通过看 github.com/go-sql-driver 包整理出来的，其中有很多字段的含义有很多选择的，就没有太多深入了解了，例如客户端发送连接报文，客户端标识设置了CLIENT_CONNECT_WITH_DB，那么连接的数据库名就是必须的了，这些字段有几十个，先挖个坑，有机会再看吧。